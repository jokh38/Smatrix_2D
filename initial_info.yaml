# ==============================================================================
# INITIAL PARTICLE STATE
# ==============================================================================
# User-configurable simulation scenario for Smatrix 2D
# Physics models are determined by NIST/PDG data - not configurable here
# ==============================================================================

particle:
  # Initial beam energy
  energy:
    value: 70.0          # MeV
    unit: MeV
    description: "Initial proton beam energy"

  # Initial beam angle (0° = forward/vertical along +z, 90° = right/horizontal along +x)
  angle:
    value: 0.0           # degrees
    unit: degrees
    description: "Initial beam direction (0° = along +z axis, 90° = along +x axis)"

  # Initial beam width (Gaussian spot size)
  beam_width:
    value: 1.0           # mm (sigma of Gaussian profile)
    unit: mm
    description: "Initial beam width (Gaussian sigma, sigma=1mm for narrow pencil beam)"

  # Initial spatial position
  position:
    x:
      value: 6.0         # mm (center of [0, 12] mm domain)
      unit: mm
      description: "Initial lateral position (center of x-domain)"
    z:
      value: 0.0         # mm
      unit: mm
      description: "Initial depth position (entry surface)"

  # Initial particle weight
  weight:
    value: 1.0           # dimensionless
    description: "Initial particle weight (normalized to 1)"

# ==============================================================================
# SPATIAL GRID CONFIGURATION
# ==============================================================================
grid:
  spatial:
    x:
      min: 0.0           # mm
      max: 12.0          # mm
      delta: 1.0         # mm
      unit: mm
      description: "Lateral domain (perpendicular to beam direction)"

    z:
      min: 0.0           # mm
      max: 60.0          # mm (expanded to capture Bragg peak at ~40mm)
      delta: 1.0         # mm
      unit: mm
      description: "Depth domain (along beam direction)"

  # Angular grid (scattering angle distribution)
  angular:
    center: 0.0          # degrees (beam direction)
    half_range: 40.0     # degrees (expanded to reduce particle escape and observe Bragg peak)
    delta: 0.25          # degrees (FURTHER IMPROVED: 0.25° to better resolve scattering)
    unit: degrees
    description: "Angular scattering domain (θ = center ± half_range)"

  # Energy grid (energy loss straggling)
  energy:
    min: 0.1             # MeV (extended to capture Bragg peak formation)
    max: 70.0            # MeV
    delta: 0.2           # MeV
    cutoff: 1.1          # MeV (particles below this energy are absorbed - E_cutoff - E_min >= 1.0 for stability)
    unit: MeV
    description: "Energy loss domain"

# ==============================================================================
# MATERIAL CONFIGURATION
# ==============================================================================
# Material determines which NIST/PDG physics data is loaded
# Available materials: H2O, AIR, GRAPHITE, AL, CU, PB, TISSUE_ICRU, TISSUE_ICRP, BONE_COMPACT, BONE_CORTICAL
material: "H2O"

# ==============================================================================
# NUMERICAL SAFEGUARDS
# ==============================================================================
# User-adjustable thresholds for numerical stability
numerical:
  safeguards:
    beta_sq_minimum: 1.0e-12
    log_argument_minimum: 1.0e-12
    dose_threshold: 1.0e-6
    weight_threshold: 1.0e-6
    description: "Numerical safeguards to prevent division by zero and underflow"

# ==============================================================================
# TRANSPORT SETTINGS
# ==============================================================================
transport:
  delta_s: 1.0            # mm - step size
  max_steps: 130          # Maximum number of transport steps (increased for 60mm domain)

# ==============================================================================
# RESOLUTION CONFIGURATION
# ==============================================================================
resolution:
  propagation:
    mode: "auto"          # Options: auto, fixed
    multiplier: 0.5       # Used when mode=auto: delta_s = multiplier * min(delta_x, delta_z)
    value: 0.5            # Used when mode=fixed: fixed step size in mm

# ==============================================================================
# CONVERGENCE CRITERIA
# ==============================================================================
convergence:
  min_weight: 1.0e-4      # Stop when total weight falls below this threshold

# ==============================================================================
# OUTPUT CONFIGURATION
# ==============================================================================
# Centralized control for all simulation outputs.
# Set enabled: false for any output type to disable it and save disk space/I/O.
output:
  # Output directory for all generated files
  directory: "output"

  # HDF5 profile data (always enabled for internal processing)
  hdf5_profiles:
    enabled: true
    description: "Stream 2D profiles to HDF5 (memory efficient, required for some exports)"

  # Per-step lateral profile tracking
  lateral_per_step_csv:
    enabled: true
    description: "Track lateral beam profile evolution at each transport step"

  # Detailed energy debug tracking
  energy_debug_csv:
    enabled: true
    description: "Track energy, stopping power, and energy loss per (z,x) position"

  # Cumulative lateral profile with statistics
  lateral_detailed_csv:
    enabled: true
    description: "Export cumulative lateral profile with theta/E statistics for all particles"

  # Detailed step-by-step transport data
  detailed_steps_csv:
    enabled: true
    description: "Save particle distribution data for each transport step"

  # Centroid tracking data
  centroids_csv:
    enabled: true
    description: "Save centroid and RMS statistics for each step"

  # Summary statistics
  summary_csv:
    enabled: true
    description: "Save simulation summary statistics"

  # Full profile data export (large file - disabled by default)
  profile_csv:
    enabled: false
    description: "Export full profile data to CSV (can be very large)"

  # Profile analysis text file
  profile_analysis:
    enabled: true
    description: "Generate profile analysis text report"

  # Figures
  figures:
    enabled: true
    format: "png"        # Options: png, pdf, svg
    dpi: 150
    combined_results:
      enabled: true
      description: "Generate combined 2x2 results figure"
    separate_figures:
      enabled: true
      description: "Generate separate individual figures"
    files:
      depth_dose:
        enabled: true
        filename: "proton_pdd"
        title: "Proton Percentage Depth Dose (PDD)"
        description: "Depth-dose curve showing Bragg peak"
      dose_map_2d:
        enabled: true
        filename: "proton_dose_map_2d"
        title: "2D Dose Distribution"
        description: "2D spatial dose distribution map"
      lateral_spreading:
        enabled: true
        filename: "lateral_spreading_analysis"
        title: "Lateral Spreading Analysis"
        description: "Analysis of lateral beam spreading with depth"

  # Checkpoint system
  checkpoints:
    enabled: true
    interval: 50         # Save checkpoint every N steps
    description: "Enable crash recovery with checkpoint files"

  # Console output verbosity
  verbosity: 1           # 0=minimal, 1=normal, 2=verbose
  description: "Level of detail for console output"

  # Streaming control (advanced)
  streaming:
    profile_save_interval: 1    # Save profile data every N steps
    sync_interval: 10           # Sync to CPU every N steps for monitoring
    description: "Control data streaming frequency"

# ==============================================================================
# METADATA
# ==============================================================================
metadata:
  simulation_type: "GPU Monte Carlo Particle Transport"
  particle_type: "Proton"
  target_material: "Water (Liquid)"
  physics:
    - "Multiple Coulomb scattering (Molière/Highland theory)"
    - "Energy loss (Bethe-Bloch formula with NIST PSTAR data)"
    - "Spatial streaming (theta-dependent transport)"
    - "Lateral spreading (angular scattering → spatial dispersion)"
  code_version: "Smatrix_2D v2.0"
  date: "2026-01-16"
  description: "GPU-accelerated proton pencil beam dose calculation"
