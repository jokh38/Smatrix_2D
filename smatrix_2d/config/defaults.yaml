# ==============================================================================
# Default Configuration for Smatrix_2D Simulation
# ==============================================================================
# This file contains CODE-LEVEL defaults used throughout the simulation.
# This is the Single Source of Truth (SSOT) for internal configuration.
#
# IMPORTANT: This file is for DEVELOPERS, not users.
# - User-facing scenario configuration goes in: initial_info.yaml (project root)
# - Code-level internal defaults go here: defaults.yaml (smatrix_2d/config/)
#
# Configuration Split:
# -----------------------------------------------------------------------------
# initial_info.yaml (User-Facing):           defaults.yaml (Code-Level):
# -----------------------------------------------------------------------------
# - Particle beam settings                   - Data type policies
# - Grid domain (min, max, delta)            - Validation tolerances
# - Material selection                       - Internal algorithm settings
# - Numerical safeguards                     - GPU kernel defaults
# - Transport step size                      - Debug/profiling settings
# - Convergence criteria                     - Boundary policies
# - Output settings                          - Synchronization
#
# To modify defaults, edit this YAML file. The Python module (yaml_loader.py)
# loads these values at runtime and exposes them as constants.
#
# Modification Policy:
# - All code-level defaults must be in this file
# - Do not hardcode default values elsewhere in the codebase
# - Use explicit imports: from smatrix_2d.config.defaults import DEFAULT_E_MIN

# =============================================================================
# Energy Grid Defaults
# =============================================================================
energy_grid:
  # Minimum energy in the simulation grid (MeV)
  # Note: Must be less than E_cutoff. A buffer of at least 1 MeV is recommended.
  e_min: 1.0

  # Energy cutoff threshold (MeV)
  # Particles below this energy are considered stopped and contribute to dose.
  # CRITICAL: E_cutoff must be > E_min to avoid numerical instability at grid edges.
  e_cutoff: 2.0

  # Maximum energy in the simulation grid (MeV)
  # Should be set based on the beam energy. For a 70 MeV beam, use ~70-75 MeV.
  e_max: 100.0

  # Minimum buffer between E_min and E_cutoff (MeV)
  # This buffer prevents numerical instability when E_cutoff is too close to E_min.
  # Enforcement: E_cutoff >= E_min + E_BUFFER_MIN
  e_buffer_min: 1.0

  # Default number of energy bins
  ne: 100

  # Energy grid type - how energy bins are distributed
  # Options: UNIFORM (equal spacing), NON_UNIFORM (higher resolution near Bragg peak)
  energy_grid_type: "non_uniform"

# =============================================================================
# Spatial Grid Defaults
# =============================================================================
spatial_grid:
  # Spatial domain half-width (mm)
  # The domain is [-SPATIAL_HALF_SIZE, +SPATIAL_HALF_SIZE] in both x and z
  half_size: 50.0

  # Default spatial resolution (mm)
  delta_x: 1.0
  delta_z: 1.0

  # Default number of spatial grid points
  # These are computed from domain size and resolution:
  # Nx = 2 * SPATIAL_HALF_SIZE / delta_x
  # Nz = 2 * SPATIAL_HALF_SIZE / delta_z
  nx: 100
  nz: 100

  # Default boundary policy for spatial domain
  boundary_policy: absorb

# =============================================================================
# Angular Grid Defaults
# =============================================================================
angular_grid:
  # Angular domain (degrees)
  # Using absolute angles [0, 180] rather than circular [-90, 90]
  theta_min: 0.0
  theta_max: 180.0

  # Default angular resolution (degrees)
  ntheta: 180

  # Default boundary policy for angular domain
  boundary_policy: absorb

# =============================================================================
# Transport Defaults (Code-Level)
# =============================================================================
transport:
  # Default transport step size [mm]
  # Should be <= min(delta_x, delta_z) to avoid bin-skipping artifacts
  delta_s: 1.0

  # Default maximum number of transport steps
  # Simulation stops when this limit is reached (even if beam hasn't fully stopped)
  max_steps: 100

  # Default number of sub-steps per operator
  # Increasing this improves stability at the cost of performance
  sub_steps: 1

  # Default operator splitting method (internal algorithm choice)
  # Options: first_order, strang_splitting
  splitting_type: first_order

  # Default policy for handling backward-traveling particles
  # Options: hard_reject, soft_absorb
  backward_transport_policy: hard_reject

# =============================================================================
# Numerical Defaults (Code-Level Fallbacks)
# =============================================================================
# Note: User-adjustable safeguards are in initial_info.yaml
# These are code-level fallbacks when user config is not provided
numerical:
  # Weight threshold for particle tracking (code-level fallback)
  # Particles with weight below this are not tracked (variance reduction)
  weight_threshold: 1.0e-10

  # Minimum beta squared for scattering calculations
  # Prevents numerical issues at very low energies
  beta_sq_min: 0.01

# =============================================================================
# Data Type Policies (Code-Level)
# =============================================================================
dtypes:
  # Primary phase space tensor dtype
  # float32: Good balance of performance and precision (recommended for GPU)
  # float64: Higher precision but 2x memory usage (use for validation/debug)
  psi: float32

  # Dose/deposited energy dtype
  # float32: Sufficient for most clinical applications
  # float64: Use for high-precision validation or research
  dose: float32

  # Accumulator dtype (escape channels, conservation tracking)
  # float64: Required for accurate mass conservation tracking
  # DO NOT change to float32 or you will lose conservation accuracy
  acc: float64

  # Stopping power LUT dtype
  # float32: Sufficient precision for interpolation
  lut: float32

# =============================================================================
# Sigma Bucket Defaults (Angular Scattering - Internal)
# =============================================================================
sigma_buckets:
  # Number of sigma buckets for angular scattering kernel
  # More buckets = more accurate but higher memory usage
  n_buckets: 10

  # Sigma cutoff for angular scattering (degrees)
  # Scatter angles beyond this are truncated (THETA_CUTOFF escape)
  theta_cutoff_deg: 45.0

# =============================================================================
# GPU Configuration Defaults (Code-Level)
# =============================================================================
# These are code-level GPU settings. Users typically don't need to change these.
gpu:
  # CUDA kernel block sizes
  kernels:
    # 1D kernel block size
    block_size_1d: 256

    # 2D kernel block sizes (x, y dimensions)
    block_size_2d: [16, 16]

    # 3D kernel block sizes (x, y, z dimensions)
    block_size_3d: [8, 8, 8]

  # Early exit threshold for GPU kernels
  early_exit_threshold: 1.0e-12

  # Accumulation mode for atomic operations
  # Options: FAST (non-deterministic order), DETERMINISTIC (slower)
  accumulation_mode: "FAST"

  # Memory pool configuration
  memory_pool:
    # Fraction of available VRAM to use for CuPy memory pool
    fraction: 0.8

  # Profiling settings (for performance analysis)
  profiling:
    enabled: true

# =============================================================================
# Synchronization Defaults (Debug/Development)
# =============================================================================
synchronization:
  # Default sync interval for GPU->CPU data transfer
  # 0: Only sync at the end of simulation (maximum performance)
  # N > 0: Sync every N steps (for debugging/monitoring)
  sync_interval: 0

# =============================================================================
# Tolerance Defaults (Validation/Testing)
# =============================================================================
# These are used for automated testing, not user simulations
tolerances:
  # Mass conservation tolerance (relative error)
  # Mass balance should be satisfied within this fraction
  mass_conservance_rel: 1.0e-6

  # Dose comparison tolerance (relative error)
  # For golden snapshot comparison
  dose_rel: 1.0e-4
  dose_abs: 1.0e-6

  # Escape channel tolerance (relative error)
  # Escapes are more sensitive due to float64 accumulation
  escape_rel: 1.0e-6
  escape_abs: 1.0e-10

# =============================================================================
# Determinism Level Defaults (Debug/Development)
# =============================================================================
determinism:
  # Default determinism level (see enums.py for details)
  # 0 (FAST): Best performance, tolerance-based testing
  # 1 (SAFE): Deterministic atomic operations
  # 2 (VALIDATION): Full determinism for validation
  level: 0

# =============================================================================
# Deprecated Legacy Defaults (for compatibility)
# =============================================================================
legacy:
  # These are kept for backward compatibility during transition.
  # DO NOT use in new code. Use the constants above instead.
  e_min_old: 0.0  # Old default, causes E_min/E_cutoff conflict
  e_cutoff_old: 1.0  # Old default, too close to E_min
